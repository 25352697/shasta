<!DOCTYPE html>
<html>

<head>
<link rel=stylesheet href=style.css />
<link rel=icon href=CZI-new-logo.png />
</head>

<body>
        <nav role="navigation">
                <ul>
                    <a class="main-nav" href=index.html><li >Shasta</li></a>
                        <a href=QuickStart.html><li>Quick Start</li></a>
                        
                        <li aria-haspopup="true"> How to
                        <ul class="dropdown" aria-label="submenu">
                        <a href=Running.html><li>Run an assembly</li></a>
                        <a href=Performance.html><li>Maximize assembly performance</li></a>
                        <a href=BuildingFromSource.html><li>Build the code from source</li></a>
                        <a href=InspectingResults.html><li>Inspect or debug assembly results</li></a>
                        <a href=Contributing.html><li>Contribute to Shasta</li></a>
                        <a href=ReportingBugs.html><li>Report problems or ask questions</li></a>
                        </ul>
                    </li>
                    <li aria-haspopup="true"> About
                            <ul class="dropdown" aria-label="submenu">
                                    <a href=Motivation.html><li>Motivation</li></a>
                                    <a href=CurrentStatus.html><li>Current status</li></a>
                                    <a href=SupportedPlatforms.html><li>Supported platforms</li></a>
                                    <a href=Acknowledgments.html><li>Acknowledgments</li></a>
                                    <a href=ComputationalMethods.html><li>Computational methods</li></a>
                                    <a href=Compatibility.html><li>Compatibility across releases</li></a>
            
                            </ul>
                        </li>
            
                </ul>
            </nav>
<main>
<h1>Running an assembly</h1>

<p>
For quick start information, see <a href=QuickStart.html>here</a>.
This section provides additional background information.

<h2>The Shasta executable</h3>
<p>
The Shasta executable provides the most convenient way of running
an assembly. If you downloaded it as a single file from a release on GitHub, the
executable is named <code>shasta-Linux-X.Y.Z</code> for Linux
or <code>shasta-macOS-X.Y.Z</code> for macOS. 
Here, <code>X.Y.Z</code> identifies the release.
If you build the code from source yourself, the
executable is <code>shasta-install/bin/shasta</code>.

<p>
The Shasta executable requires no installation or set up, 
and has no dependencies. The Linux version, which is statically linked,
runs on most current 64-bit Linux distributions, including
at least the following:

<ul>
<li>Ubuntu 16.04 and 18.04
<li>Linux Mint 18.3
<li>CentOS 7.6
<li>Debian 9
<li>Fedora 29
</ul>

<p>
If you downloaded the executable from GitHub,
you will have to set execute permissions before running it
(the browser will not do that for you, for security reasons).
This can be done as follows:

<pre>
chmod ugo+x shasta-Linux-X.Y.Z
</pre>
or
<pre>
chmod ugo+x shasta-macOS-X.Y.Z
</pre>

<p>
You can invoke the Shasta executable without options or with
<code>--help</code> to get a description of the options.
Most options control assembly parameters whose default
value works well for an assembly with typical coverage
around 60x, and don't need to be changed in many cases.

<p>
Keep in mind that these default parameter values
include a read length cutoff of 10 Kb, which means 
all reads shorter than that are discarded on input.
On current data from sequencing runs at UCSC, this result
in a very small loss in coverage.

<p>
The only mandatory options is <code>--input</code> 
which must be used to specify the input FASTA files
containing reads to be used for the assembly.
If there is more than one file, the names
should be specified separated by white space,
entering <code>--input</code> only once, like this:

<pre>
--input a.fasta b.fasta c.fasta
</pre>



<h2>Memory modes</h2>

<p>
(This section does not apply to macOS).

<p>
For performance, the Shasta executable operates in memory,
with no access to data on disk except during
initial input of the reads, final output of the assembly,
and for small output files containing summary assembly information.
All large memory areas are allocated using <code>mmap</code> 
calls in one of several different modes of operation
described below. 
The choice of the optimal mode of operation is dependent
on many factors and decribed below.
The default mode of operation works reasonably well in most cases
and does not require root privilege. 
However, it does not deliver the best possible performance.

<p>
The memory modes are controlled by two command line options:

<ul>
<li><code>--memoryMode</code> controls whether <code>mmap</code>
allocates anonymous memory or memory mapped to a filesystem.
It can take one of the following values:
<ul>
<li><code>anonymous</code> (the default value)
<li><code>filesystem</code>
</ul> 

<li><code>--memoryBacking</code> specifies the physical backing
of pages allocated via <code>mmap</code> and can take
one of the following values:
<ul>
<li><code>disk</code>: <code>mmap</code> uses standard 4 KB pages
mapped to the existing filesystem on disk in the current directory.
<li><code>4K</code> (the default value): <code>mmap</code> uses standard 4 KB pages
(anonymous or on a <code>tmpfs</code> filesystem, depending
on the setting of <code>--memoryBacking</code>).
<li><code>2M</code>: <code>mmap</code> uses large 2 MB pages
(anonymous or on a <code>hugetlbfs</code> filesystem, depending
on the setting of <code>--memoryBacking</code>).
The 2MB pages are often referred to as "huge pages".
</ul>
</ul>


<p>
There are a total six possible combinations of these two options, summarized
in the table below.



<table>

<tr>
<td colspan=2 rowspan=2>
<td colspan=2 class=centered><code>--memoryMode</code>

<tr>
<td class=centered><code>anonymous</code><br>(default)
<td class=centered><code>filesystem</code>

<tr>
<td rowspan=3><code>--memoryBacking</code>
<td class=centered><code>disk</code>
<td class="centered error">Not allowed
<td class="success">
Memory allocated by <code>mmap</code> uses 4 KB pages
on a the filesystem on disk that
the run output directory is in.
<b>This mode of operation incurs severe performance degradation</b>,
at least for large runs -
a slowdown of a factor of 3 or more.
After the run terminates, binary data are permanently available 
on disk
and you can use the http server or
the Python API to inspect assembly results.

<tr>
<td class=centered><code>4K</code><br>(default)
<td class="success">
The default option.
Memory allocated by <code>mmap</code> uses anonymous 4 KB pages.
After the run terminates, binary data are destroyed,
which means you cannot use the http server or
the Python API to inspect assembly results.
<b>Performance is less than optimal</b> (typically 30% degradation 
on a large run).
<td class="warning">
Memory allocated by <code>mmap</code> uses 4 KB pages
on a <code>tmpfs</code> filesystem which is created
and mounted on the <code>Data</code> directory
under the run output directory.
After the run terminates, binary data are available 
(until the next reboot)
and you can use the http server or
the Python API to inspect assembly results.
<b>Performance is less than optimal.</b>
When done using the binary data, you can free
the  memory using the following command:
<code>shasta --command cleanup</code>.

<tr>
<td class=centered><code>2M</code>
<td class="warning">
Memory allocated by <code>mmap</code> uses anonymous 2 MB pages.
After the run terminates, binary data are destroyed,
which means you cannot use the http server or
the Python API to inspect assembly results.
<b>Performance is less than optimal</b> (typically 30% degradation 
on a large run).
<td class="warning">
Memory allocated by <code>mmap</code> uses 2 MB pages
on a <code>hugetlbfs</code> filesystem which is created
and mounted on the <code>Data</code> directory
under the run output directory.
After the run terminates, binary data are available 
(until the next reboot)
and you can use the http server or
the Python API to inspect assembly results.
<b>This mode of operation delivers optimal performance.</b>
When done using the binary data, you can free
the  memory using the following command:
<code>shasta --command cleanup</code>.

</table>

<div class="table-legend">
The table is color coded with the following meaning:

<div>
        <div class="color-box error"></div>
This combination is not allowed.
</div>
<div>
    <div class="color-box warning"></div>
This combination requires root privilege to be acquired
via <code>sudo</code>.
Depending on <code>sudo</code> settings, this
may fail or ask for a user password.
</div>
<div>
        <div class="color-box success"></div>
This combination is allowed and does not require
root privilege.
</div>
</div>


<p>
In summary:
<ul>
<li>
<b>For large assemblies</b> it is best to 
make sure to have root privilege and use
<code>--memoryMode filesystem --memoryBacking 2M</code>.
Remember to use <code>shasta --command cleanup</code>
to free up the memory when done using the binary data!

<li>
<b>For small assemblies for which performance is not important</b> 
use the default mode
<code>--memoryMode anonymous --memoryBacking 4K</code>.
However, if access to binary data is required after the assembly completes
to inspect assembly results using the http server or the Python API, use
<code>--memoryMode filesystem --memoryBacking disk</code>.



<h2>Scripted approaches  to running an assembly</h3>
<p>
The Shasta assembler provides a
<a href=Python.html>Python API</a> that can be used for scripting.
This makes it possible to write Python scripts to run assemblies
that have more flexibility or functionality than allowed by
the Shasta executable. 
For example, these scripts allow rerunning only a portion 
of an assembly, which can be useful for development
of new assembly functionality.

<p>
These scripts use a Python <code>import</code> to import the Shasta
shared library, <code>shasta.so</code>, which provides
Python bindings to Shasta functionality. 
The scripts and the library are in <code>shasta-install/bin</code>,
but they will normally not be needed during basic operation of 
the Shasta assembler. They are more likely to be needed
for debugging, testing, or development.

<p>
The Python API also allows you to write your own assembly scripts.
For such a script to work, and under the assumption that the
script is not located at <code>shasta-install/bin</code>,
it will be necessary to set environment variable
<code>PYTHONPATH</code> to <code>(actual path)/shasta-install/bin</code>,
so the Python interpreter can locate the Shasta shared library 
during <code>import</code>.

<p>
Existing assembly scripts, which are currently undocumented, include:
<ul>
<li><code>RunAssembly.py</code>
<li><code>Run.py</code>
<li><code>SmallRun.py</code>
</ul>


<h2>Input files</h2>
<p>
The Shasta
assembler uses as input one or more 
<a href="https://en.wikipedia.org/wiki/FASTA">FASTA</a>
files containing the input reads.
The body of each read should not contain
extraneous characters such as no-called bases (<code>N</code>),
spaces, tabs, carriage returns (CR, ASCII 13), or any characters
other than 
<code>A</code>,
<code>C</code>,
<code>G</code>,
<code>T</code>,
or new line characters (LF, ASCII 10).
If the file contains Window-style line ends (ASCII 13 carriage return CR
followed by ASCII 10 line feed LF) it should first be
converted to Linux-style line ends, for example using
command <code>dos2unix</code>.

<p>
Direct input of <a href="https://en.wikipedia.org/wiki/FASTQ">FASTQ</a>
to Shasta is currently not supported.
If you have a FASTQ file, 
you can convert it to FASTA using script 
<code>shasta-install/bin/FastqToFasta.py</code>.
If your FASTQ file is compressed (extension <code>.gz</code>),
you can decompress it and convert to FASTA in one step,
saving a round trip to disk, using 
script 
<code>shasta-install/bin/FastqGzToFasta.py</code>.



<h2 id=OutputFiles>Output files</h2>
<p>
The Shasta executable creates output in a directory with a name
specified by the <code>--output</code> option (default <code>ShastaRun</code>).
The directory is created automatically at the beginning of the run. 
The run stops if the directory already exists.
This reduces the possibility of unwanted deletion of data.

<p>
Contents of the output directory after a successful run
include the following:

<ul>

<li>
<code>Assembly.fasta</code>: 
The assembly results in FASTA format.

<li><code>Assembly.gfa</code>: 
The assembly results in 
<a href=https://github.com/GFA-spec/GFA-spec/blob/master/GFA1.md>GFA 1.0</a> format.
This contains the same sequences in the FASTA file (as GFA segments),
plus their connectivity information (as GFA links). 
A convenient tool to inspect and study these files is
<a href='https://rrwick.github.io/Bandage'>Bandage</a>.
Segment ids in the GFA file correspond to FASTA ids 
in the FASTA file.

<li><code>shasta.conf</code>: 
a configuration file containing
the values of all assembly parameters used. 
This file uses a format that can also be used as input for 
a subsequent Shasta run using option <code>--config</code>.

<li><code>ReadLengthHistogram.csv</code>:
A spreadsheet file containing statistics of the read length distribution.
This only includes reads that were used by the assembler.
The assembler discards reads shorter than 
<code>Reads.minReadLength</code> bases (default 10000)
and reads that contain bases repeated more than 255 times.
The fifth field of the last line of this file
contains the total number of input bases
used by the assembler in this run.

<li><code>Binned-ReadLengthHistogram.csv</code>:
Similar to <code>ReadLengthHistogram.csv</code>,
but using 1 Kb bins of read lengths.

<li><code>Data</code>:
A directory containing binary data
that can later be used by the Shasta http server
or with the Shasta Python API.
This is only created if option
<code>--memoryMode filesystem</code> 
was used for the run.
Keep in mind that, unless you used
option <code>--memoryBacking disk</code>,
these data are in memory, not on disk,
and will disappear at next reboot.
If you want to save them permanently, you can use
script <code>shasta-install/bin/SaveRun.py</code>
to create a copy on disk of the binary data directory named
<code>DataOnDisk</code>. 
(You can also make the copy yourself using the <code>cp</code> command).
To free up the memory used without rebooting, you can invoke the 
Shasta executable again using the following options:

<pre>
--command cleanup --output outputDirectoryName
</pre>
Here, <code>outputDirectoryName</code>
should specify the same value used in the assembly run
(that is, the name of the directory containing the <code>Data</code>
directory).
Equivalently, you can just <code>umount</code> the <code>Data</code>
directory, then remove it. 


</ul>



</main>

</body>
</html>

